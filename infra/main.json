{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "9434068036200684310"
    }
  },
  "parameters": {
    "namePrefix": {
      "type": "string",
      "minLength": 3,
      "maxLength": 12,
      "metadata": {
        "description": "Prefix applied to most resource names."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources."
      }
    },
    "pdsHostname": {
      "type": "string",
      "minLength": 4,
      "maxLength": 253,
      "metadata": {
        "description": "Fully qualified hostname clients use to reach the PDS (e.g. pds.example.com)."
      }
    },
    "pdsImageTag": {
      "type": "string",
      "minLength": 1,
      "maxLength": 128,
      "metadata": {
        "description": "Container image tag for ghcr.io/bluesky-social/pds (e.g. 0.4)."
      }
    },
    "ingressCertificateName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional name of a Container Apps certificate resource (within the managed environment) to bind to the ingress. Leave empty to skip automatic binding."
      }
    },
    "enableManagedCertificate": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to let Azure Container Apps request and renew a managed certificate when no existing certificate name is provided."
      }
    },
    "pdsCpu": {
      "type": "string",
      "defaultValue": "0.5",
      "metadata": {
        "description": "CPU request for the PDS container in cores."
      }
    },
    "pdsMemory": {
      "type": "string",
      "defaultValue": "1Gi",
      "metadata": {
        "description": "Memory request for the PDS container."
      }
    },
    "enableHttp": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to allow unauthenticated HTTP (port 80) alongside HTTPS."
      }
    },
    "minReplicas": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Minimum number of replicas the container app should maintain."
      }
    },
    "maxReplicas": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Maximum number of replicas the container app may scale to."
      }
    },
    "pdsJwtSecretName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 127,
      "metadata": {
        "description": "Name of the Key Vault secret containing the PDS JWT secret."
      }
    },
    "pdsAdminPasswordSecretName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 127,
      "metadata": {
        "description": "Name of the Key Vault secret containing the PDS admin password."
      }
    },
    "pdsPlcRotationKeySecretName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 127,
      "metadata": {
        "description": "Name of the Key Vault secret containing the PLC rotation key (hex)."
      }
    },
    "smtpSecretName": {
      "type": "string",
      "defaultValue": "PDS-SMTP-URL",
      "minLength": 1,
      "maxLength": 127,
      "metadata": {
        "description": "Name of the Key Vault secret containing the SMTP connection string or password."
      }
    },
    "emailFromAddressSecretName": {
      "type": "string",
      "defaultValue": "PDS-EMAIL-FROM-ADDRESS",
      "minLength": 1,
      "maxLength": 127,
      "metadata": {
        "description": "Name of the Key Vault secret containing the computed email from address."
      }
    },
    "emailFromAddress": {
      "type": "string",
      "defaultValue": "",
      "maxLength": 320,
      "metadata": {
        "description": "From address to use when PDS sends email. Leave empty to auto-use Azure-managed domain when enableCommunicationServices=true."
      }
    },
    "enableCommunicationServices": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to provision Azure Communication Services for email sending."
      }
    },
    "emailCustomDomain": {
      "type": "string",
      "defaultValue": "",
      "maxLength": 253,
      "metadata": {
        "description": "Custom domain name for Azure Communication Services Email (e.g. notify.example.com). Leave empty to use Azure-managed domain."
      }
    },
    "adminObjectId": {
      "type": "string",
      "minLength": 36,
      "maxLength": 36,
      "metadata": {
        "description": "Object ID for an administrator that should have full access to the Key Vault."
      }
    },
    "dnsZoneName": {
      "type": "string",
      "defaultValue": "",
      "maxLength": 253,
      "metadata": {
        "description": "Optional DNS zone name (e.g. example.com). Leave empty to skip DNS record creation."
      }
    },
    "dnsRecordName": {
      "type": "string",
      "defaultValue": "pds",
      "minLength": 1,
      "maxLength": 63,
      "metadata": {
        "description": "Optional relative record for the container app within the DNS zone (e.g. pds). Ignored when dnsZoneName is empty."
      }
    },
    "logAnalyticsRetentionDays": {
      "type": "int",
      "defaultValue": 30,
      "minValue": 7,
      "maxValue": 730,
      "metadata": {
        "description": "Retention in days for Log Analytics data."
      }
    },
    "snapshotContainerName": {
      "type": "string",
      "defaultValue": "pds-sqlite",
      "minLength": 3,
      "maxLength": 63,
      "metadata": {
        "description": "Name of the blob container used to store SQLite snapshot archives."
      }
    },
    "snapshotPrefix": {
      "type": "string",
      "defaultValue": "snapshots",
      "minLength": 1,
      "metadata": {
        "description": "Prefix applied to snapshot blob paths."
      }
    },
    "backupIntervalSeconds": {
      "type": "int",
      "defaultValue": 15,
      "minValue": 5,
      "metadata": {
        "description": "Interval in seconds between snapshot uploads."
      }
    },
    "backupRetentionCount": {
      "type": "int",
      "defaultValue": 200,
      "minValue": 10,
      "metadata": {
        "description": "Number of snapshot archives to retain in object storage."
      }
    }
  },
  "variables": {
    "tenantId": "[subscription().tenantId]",
    "pdsImage": "[format('ghcr.io/bluesky-social/pds:{0}', parameters('pdsImageTag'))]",
    "cleanedNamePrefix": "[replace(format('{0}{1}', parameters('namePrefix'), uniqueString(resourceGroup().id)), '-', '')]",
    "storageAccountName": "[toLower(if(greater(length(variables('cleanedNamePrefix')), 24), substring(variables('cleanedNamePrefix'), 0, 24), variables('cleanedNamePrefix')))]",
    "containerAppName": "[format('{0}-pds-app', parameters('namePrefix'))]",
    "containerAppIdentityName": "[format('{0}-pds-id', parameters('namePrefix'))]",
    "keyVaultName": "[format('{0}-{1}-kv', parameters('namePrefix'), uniqueString(resourceGroup().id))]",
    "logAnalyticsName": "[format('{0}-law', parameters('namePrefix'))]",
    "managedEnvName": "[format('{0}-cae', parameters('namePrefix'))]",
    "hasIngressCertificate": "[greater(length(parameters('ingressCertificateName')), 0)]",
    "useManagedCertificate": "[and(not(variables('hasIngressCertificate')), parameters('enableManagedCertificate'))]",
    "managedCertificateEnabled": "[and(variables('useManagedCertificate'), not(equals(parameters('dnsZoneName'), '')))]",
    "managedCertificateName": "[format('{0}-pds-managed-cert', parameters('namePrefix'))]",
    "ingressCertificateResourceId": "[if(variables('hasIngressCertificate'), resourceId('Microsoft.App/managedEnvironments/certificates', variables('managedEnvName'), parameters('ingressCertificateName')), '')]",
    "managedCertificateResourceId": "[if(variables('managedCertificateEnabled'), resourceId('Microsoft.App/managedEnvironments/managedCertificates', variables('managedEnvName'), variables('managedCertificateName')), '')]",
    "ingressCustomDomains": "[if(variables('hasIngressCertificate'), createArray(createObject('name', parameters('pdsHostname'), 'certificateId', variables('ingressCertificateResourceId'), 'bindingType', 'SniEnabled')), createArray())]",
    "storageAccountKeySecretName": "storage-account-key",
    "communicationServiceName": "[format('{0}-acs', parameters('namePrefix'))]",
    "emailServiceName": "[format('{0}-email', parameters('namePrefix'))]",
    "hasEmailFromOverride": "[greater(length(parameters('emailFromAddress')), 0)]",
    "includeSmtpSecret": "[greater(length(parameters('smtpSecretName')), 0)]",
    "backupRestoreScriptContent": "#!/usr/bin/env sh\nset -euo pipefail\n\nDATA_DIR=${DATA_DIR:-/data}\nWORK_DIR=${WORK_DIR:-/work}\nSNAPSHOT_CONTAINER=${SNAPSHOT_CONTAINER:-pds-sqlite}\nSNAPSHOT_PREFIX=${SNAPSHOT_PREFIX:-snapshots}\nACCOUNT_NAME=${AZURE_STORAGE_ACCOUNT_NAME:?AZURE_STORAGE_ACCOUNT_NAME is required}\nACCOUNT_KEY=${AZURE_STORAGE_ACCOUNT_KEY:?AZURE_STORAGE_ACCOUNT_KEY is required}\nPDS_ID=${PDS_ID:-default}\nSENTINEL_PATH=${SENTINEL_PATH:-\"$DATA_DIR/.restore-complete\"}\nDOWNLOAD_PATH=\"$WORK_DIR/restore.tar.zst\"\n\nmkdir -p \"$DATA_DIR\" \"$WORK_DIR\"\n\nif [ \"$(find \"$DATA_DIR\" -mindepth 1 -print -quit 2>/dev/null)\" ]; then\n  echo \"[restore] Data directory already populated; skipping snapshot restore.\"\n  touch \"$SENTINEL_PATH\"\n  exit 0\nfi\n\necho \"[restore] Looking for latest snapshot in container '$SNAPSHOT_CONTAINER' with prefix '$SNAPSHOT_PREFIX/$PDS_ID'\"\nLATEST_BLOB=$(az storage blob list \\\n  --account-name \"$ACCOUNT_NAME\" \\\n  --account-key \"$ACCOUNT_KEY\" \\\n  --container-name \"$SNAPSHOT_CONTAINER\" \\\n  --prefix \"$SNAPSHOT_PREFIX/$PDS_ID/\" \\\n  --query \"max_by(@, &properties.lastModified).name\" -o tsv 2>/dev/null || true)\n\nif [ -z \"${LATEST_BLOB:-}\" ]; then\n  echo \"[restore] No snapshots found; starting with empty state.\"\n  touch \"$SENTINEL_PATH\"\n  exit 0\nfi\n\necho \"[restore] Downloading snapshot blob $LATEST_BLOB\"\naz storage blob download \\\n  --account-name \"$ACCOUNT_NAME\" \\\n  --account-key \"$ACCOUNT_KEY\" \\\n  --container-name \"$SNAPSHOT_CONTAINER\" \\\n  --name \"$LATEST_BLOB\" \\\n  --file \"$DOWNLOAD_PATH\" \\\n  --overwrite true >/dev/null\n\nif [ ! -s \"$DOWNLOAD_PATH\" ]; then\n  echo \"[restore] Downloaded archive is empty; aborting.\"\n  exit 1\nfi\n\necho \"[restore] Extracting archive into $DATA_DIR\"\nrm -rf \"$DATA_DIR\"/*\nzstd -d -c \"$DOWNLOAD_PATH\" | tar -x -C \"$DATA_DIR\"\n\ntouch \"$SENTINEL_PATH\"\necho \"[restore] Restore complete.\"\n",
    "backupLoopScriptContent": "#!/usr/bin/env sh\nset -euo pipefail\n\nDATA_DIR=${DATA_DIR:-/data}\nWORK_DIR=${WORK_DIR:-/work}\nACCOUNT_NAME=${AZURE_STORAGE_ACCOUNT_NAME:?AZURE_STORAGE_ACCOUNT_NAME is required}\nACCOUNT_KEY=${AZURE_STORAGE_ACCOUNT_KEY:?AZURE_STORAGE_ACCOUNT_KEY is required}\nSNAPSHOT_CONTAINER=${SNAPSHOT_CONTAINER:-pds-sqlite}\nSNAPSHOT_PREFIX=${SNAPSHOT_PREFIX:-snapshots}\nPDS_ID=${PDS_ID:-default}\nINTERVAL_SECONDS=${INTERVAL_SECONDS:-15}\nRETAIN_COUNT=${RETAIN_COUNT:-200}\nSENTINEL_PATH=${SENTINEL_PATH:-\"$DATA_DIR/.restore-complete\"}\n\nmkdir -p \"$WORK_DIR\"\n\ncleanup() {\n  rm -rf \"$WORK_DIR\"/snapshot-* \"$WORK_DIR\"/archive-*.tar.zst 2>/dev/null || true\n}\n\ntrap cleanup EXIT INT TERM\n\nwait_for_restore() {\n  while [ ! -f \"$SENTINEL_PATH\" ]; do\n    echo \"[backup] Waiting for restore sentinel at $SENTINEL_PATH\"\n    sleep 2\n  done\n}\n\nsnapshot_iteration() {\n  TS=$(date -u +\"%Y%m%d-%H%M%S\")\n  STAGING=\"$WORK_DIR/snapshot-$TS\"\n  ARCHIVE=\"$WORK_DIR/archive-$TS.tar.zst\"\n\n  rm -rf \"$STAGING\"\n  mkdir -p \"$STAGING\"\n\n  echo \"[backup] Creating staging copy of $DATA_DIR\"\n  tar -C \"$DATA_DIR\" -cf - . | tar -C \"$STAGING\" -xf -\n  find \"$STAGING\" -type f \\( -name \"*.sqlite\" -o -name \"*.sqlite-wal\" -o -name \"*.sqlite-shm\" \\) -delete\n\n  echo \"[backup] Refreshing SQLite backups\"\n  find \"$DATA_DIR\" -type f -name \"*.sqlite\" | while read -r DB; do\n    TARGET=\"$STAGING${DB#$DATA_DIR}\"\n    mkdir -p \"$(dirname \"$TARGET\")\"\n    sqlite3 \"$DB\" \".backup '$TARGET'\"\n  done\n\n  echo \"[backup] Packaging snapshot\"\n  tar -C \"$STAGING\" -I \"zstd -3\" -cf \"$ARCHIVE\" .\n\n  BLOB_NAME=\"$SNAPSHOT_PREFIX/$PDS_ID/snap-$TS.tar.zst\"\n  echo \"[backup] Uploading $BLOB_NAME\"\n  az storage blob upload \\\n    --account-name \"$ACCOUNT_NAME\" \\\n    --account-key \"$ACCOUNT_KEY\" \\\n    --container-name \"$SNAPSHOT_CONTAINER\" \\\n    --name \"$BLOB_NAME\" \\\n    --file \"$ARCHIVE\" \\\n    --overwrite true >/dev/null\n\n  echo \"[backup] Enforcing retention (keep last $RETAIN_COUNT)\"\n  az storage blob list \\\n    --account-name \"$ACCOUNT_NAME\" \\\n    --account-key \"$ACCOUNT_KEY\" \\\n    --container-name \"$SNAPSHOT_CONTAINER\" \\\n    --prefix \"$SNAPSHOT_PREFIX/$PDS_ID/\" \\\n    --query \"sort_by(@, &name)[].name\" -o tsv |\n    awk -v keep=\"$RETAIN_COUNT\" 'NF==0 { next } { lines[NR]=$0 } END { for(i=1;i<=NR-keep;i++){ if(lines[i]!=\"\") print lines[i]; } }' |\n    while read -r OLD_BLOB; do\n      echo \"[backup] Deleting old snapshot $OLD_BLOB\"\n      az storage blob delete \\\n        --account-name \"$ACCOUNT_NAME\" \\\n        --account-key \"$ACCOUNT_KEY\" \\\n        --container-name \"$SNAPSHOT_CONTAINER\" \\\n        --name \"$OLD_BLOB\" >/dev/null || true\n    done\n}\n\nwait_for_restore\n\necho \"[backup] Starting continuous snapshot loop (interval ${INTERVAL_SECONDS}s)\"\nwhile true; do\n  snapshot_iteration || echo \"[backup] Snapshot iteration failed\"\n  cleanup\n  sleep \"$INTERVAL_SECONDS\"\ndone\n",
    "computedEmailFromAddress": "[if(variables('hasEmailFromOverride'), parameters('emailFromAddress'), if(and(parameters('enableCommunicationServices'), not(equals(parameters('emailCustomDomain'), ''))), format('donotreply@{0}', parameters('emailCustomDomain')), if(parameters('enableCommunicationServices'), 'donotreply@placeholder.azurecomm.net', 'donotreply@example.com')))]",
    "smtpPlaceholderValue": "smtps://pending-update@smtp.azurecomm.net:587"
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2018-11-30",
      "name": "[variables('containerAppIdentityName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsName')]",
      "location": "[parameters('location')]",
      "properties": {
        "retentionInDays": "[parameters('logAnalyticsRetentionDays')]",
        "features": {
          "enableLogAccessUsingOnlyResourcePermissions": true
        },
        "sku": {
          "name": "PerGB2018"
        }
      }
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2023-05-01",
      "name": "[variables('managedEnvName')]",
      "location": "[parameters('location')]",
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2022-10-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2022-10-01').primarySharedKey]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-09-01",
      "name": "[variables('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "accessTier": "Hot",
        "minimumTlsVersion": "TLS1_2",
        "supportsHttpsTrafficOnly": true,
        "allowBlobPublicAccess": false,
        "allowSharedKeyAccess": true
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/default/{1}', variables('storageAccountName'), parameters('snapshotContainerName'))]",
      "properties": {
        "publicAccess": "None"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[variables('keyVaultName')]",
      "location": "[parameters('location')]",
      "properties": {
        "tenantId": "[variables('tenantId')]",
        "sku": {
          "name": "standard",
          "family": "A"
        },
        "enablePurgeProtection": true,
        "enabledForTemplateDeployment": true,
        "accessPolicies": [
          {
            "tenantId": "[variables('tenantId')]",
            "objectId": "[parameters('adminObjectId')]",
            "permissions": {
              "secrets": [
                "get",
                "list",
                "set",
                "delete",
                "recover",
                "backup",
                "restore"
              ]
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2023-05-01",
      "name": "[variables('containerAppName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName')))]": {}
        }
      },
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('managedEnvName'))]",
        "configuration": {
          "activeRevisionsMode": "Single",
          "ingress": {
            "external": true,
            "targetPort": 2583,
            "allowInsecure": "[parameters('enableHttp')]",
            "transport": "auto",
            "traffic": [
              {
                "latestRevision": true,
                "weight": 100
              }
            ],
            "customDomains": "[variables('ingressCustomDomains')]"
          },
          "secrets": "[concat(createArray(createObject('name', 'pds-jwt-secret', 'keyVaultUrl', format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri, parameters('pdsJwtSecretName')), 'identity', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName'))), createObject('name', 'pds-admin-password', 'keyVaultUrl', format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri, parameters('pdsAdminPasswordSecretName')), 'identity', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName'))), createObject('name', 'pds-plc-key', 'keyVaultUrl', format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri, parameters('pdsPlcRotationKeySecretName')), 'identity', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName'))), createObject('name', 'pds-email-from-address', 'keyVaultUrl', format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri, parameters('emailFromAddressSecretName')), 'identity', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName'))), createObject('name', 'storage-account-key', 'keyVaultUrl', format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri, variables('storageAccountKeySecretName')), 'identity', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName')))), if(variables('includeSmtpSecret'), createArray(createObject('name', 'pds-smtp-secret', 'keyVaultUrl', format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri, parameters('smtpSecretName')), 'identity', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName')))), createArray()))]"
        },
        "template": {
          "containers": [
            {
              "name": "pds",
              "image": "[variables('pdsImage')]",
              "resources": {
                "cpu": "[json(parameters('pdsCpu'))]",
                "memory": "[parameters('pdsMemory')]"
              },
              "command": [
                "/bin/sh",
                "-c",
                "while [ ! -f /pds/.restore-complete ]; do echo \"waiting for snapshot restore\"; sleep 2; done; exec node --enable-source-maps index.js"
              ],
              "volumeMounts": [
                {
                  "volumeName": "pds-data",
                  "mountPath": "/pds"
                }
              ],
              "env": "[concat(createArray(createObject('name', 'PDS_PORT', 'value', '2583'), createObject('name', 'PDS_HOSTNAME', 'value', parameters('pdsHostname')), createObject('name', 'PDS_DATA_DIRECTORY', 'value', '/pds'), createObject('name', 'PDS_ACTOR_STORE_DIRECTORY', 'value', '/pds/actors'), createObject('name', 'PDS_BLOBSTORE_DISK_LOCATION', 'value', '/pds/blobs'), createObject('name', 'PDS_BLOBSTORE_DISK_TMP_LOCATION', 'value', '/pds/blobs/tmp'), createObject('name', 'PDS_EMAIL_FROM_ADDRESS', 'secretRef', 'pds-email-from-address'), createObject('name', 'PDS_JWT_SECRET', 'secretRef', 'pds-jwt-secret'), createObject('name', 'PDS_ADMIN_PASSWORD', 'secretRef', 'pds-admin-password'), createObject('name', 'PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX', 'secretRef', 'pds-plc-key')), if(variables('includeSmtpSecret'), createArray(createObject('name', 'PDS_EMAIL_SMTP_URL', 'secretRef', 'pds-smtp-secret')), createArray()))]"
            },
            {
              "name": "snapshot-agent",
              "image": "mcr.microsoft.com/azure-cli:2.64.0",
              "resources": {
                "cpu": "[json('0.25')]",
                "memory": "0.5Gi"
              },
              "command": [
                "/bin/sh",
                "-c",
                "set -euo pipefail; echo \"[snapshot-agent] Detecting package manager\"; if command -v apt-get >/dev/null 2>&1; then echo \"[snapshot-agent] Installing deps via apt-get\"; DEBIAN_FRONTEND=noninteractive apt-get update >/dev/null && DEBIAN_FRONTEND=noninteractive apt-get install -y sqlite3 zstd tar gawk >/dev/null; elif command -v apk >/dev/null 2>&1; then echo \"[snapshot-agent] Installing deps via apk\"; apk add --no-cache sqlite zstd tar gawk; elif command -v microdnf >/dev/null 2>&1; then echo \"[snapshot-agent] Installing deps via microdnf\"; microdnf install -y sqlite zstd tar gawk; elif command -v dnf >/dev/null 2>&1; then echo \"[snapshot-agent] Installing deps via dnf\"; dnf install -y sqlite zstd tar gawk; elif command -v yum >/dev/null 2>&1; then echo \"[snapshot-agent] Installing deps via yum\"; yum install -y sqlite zstd tar gawk; elif command -v tdnf >/dev/null 2>&1; then echo \"[snapshot-agent] Installing deps via tdnf\"; tdnf install -y sqlite tar gawk zstd; else echo \"ERROR: no supported package manager found\" >&2; exit 1; fi; printf \"%s\" \"$RESTORE_SCRIPT_B64\" | base64 -d > /scripts/restore.sh; printf \"%s\" \"$BACKUP_LOOP_SCRIPT_B64\" | base64 -d > /scripts/backup-loop.sh; chmod +x /scripts/*.sh; /scripts/restore.sh && exec /scripts/backup-loop.sh"
              ],
              "env": [
                {
                  "name": "AZURE_STORAGE_ACCOUNT_NAME",
                  "value": "[variables('storageAccountName')]"
                },
                {
                  "name": "AZURE_STORAGE_ACCOUNT_KEY",
                  "secretRef": "storage-account-key"
                },
                {
                  "name": "SNAPSHOT_CONTAINER",
                  "value": "[parameters('snapshotContainerName')]"
                },
                {
                  "name": "SNAPSHOT_PREFIX",
                  "value": "[parameters('snapshotPrefix')]"
                },
                {
                  "name": "RESTORE_SCRIPT_B64",
                  "value": "[base64(variables('backupRestoreScriptContent'))]"
                },
                {
                  "name": "BACKUP_LOOP_SCRIPT_B64",
                  "value": "[base64(variables('backupLoopScriptContent'))]"
                },
                {
                  "name": "PDS_ID",
                  "value": "[parameters('namePrefix')]"
                },
                {
                  "name": "INTERVAL_SECONDS",
                  "value": "[string(parameters('backupIntervalSeconds'))]"
                },
                {
                  "name": "RETAIN_COUNT",
                  "value": "[string(parameters('backupRetentionCount'))]"
                },
                {
                  "name": "DATA_DIR",
                  "value": "/data"
                },
                {
                  "name": "WORK_DIR",
                  "value": "/work"
                },
                {
                  "name": "SENTINEL_PATH",
                  "value": "/data/.restore-complete"
                }
              ],
              "volumeMounts": [
                {
                  "volumeName": "pds-data",
                  "mountPath": "/data"
                },
                {
                  "volumeName": "backup-scripts",
                  "mountPath": "/scripts"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": "[parameters('minReplicas')]",
            "maxReplicas": "[parameters('maxReplicas')]"
          },
          "volumes": [
            {
              "name": "pds-data",
              "storageType": "EmptyDir"
            },
            {
              "name": "backup-scripts",
              "storageType": "EmptyDir"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName'))]",
        "[resourceId('Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), parameters('emailFromAddressSecretName'))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[resourceId('Microsoft.KeyVault/vaults/accessPolicies', variables('keyVaultName'), 'add')]",
        "[resourceId('Microsoft.App/managedEnvironments', variables('managedEnvName'))]",
        "[resourceId('Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), parameters('smtpSecretName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    },
    {
      "condition": "[variables('managedCertificateEnabled')]",
      "type": "Microsoft.App/containerApps/customDomains",
      "apiVersion": "2024-03-01",
      "name": "[format('{0}/{1}', variables('containerAppName'), parameters('pdsHostname'))]",
      "properties": {
        "bindingType": "Disabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', variables('containerAppName'))]"
      ]
    },
    {
      "condition": "[variables('managedCertificateEnabled')]",
      "type": "Microsoft.App/managedEnvironments/managedCertificates",
      "apiVersion": "2024-03-01",
      "name": "[format('{0}/{1}', variables('managedEnvName'), variables('managedCertificateName'))]",
      "location": "[parameters('location')]",
      "properties": {
        "subjectName": "[parameters('pdsHostname')]",
        "domainControlValidation": "TXT"
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps/customDomains', variables('containerAppName'), parameters('pdsHostname'))]",
        "[resourceId('Microsoft.Network/dnsZones/TXT', parameters('dnsZoneName'), format('asuid.{0}', parameters('dnsRecordName')))]",
        "[resourceId('Microsoft.App/managedEnvironments', variables('managedEnvName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/accessPolicies",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', variables('keyVaultName'), 'add')]",
      "properties": {
        "accessPolicies": [
          {
            "tenantId": "[variables('tenantId')]",
            "objectId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName')), '2018-11-30').principalId]",
            "permissions": {
              "secrets": [
                "get",
                "list"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName'))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.App/containerApps/{0}', variables('containerAppName'))]",
      "name": "[format('{0}-metrics', variables('containerAppName'))]",
      "properties": {
        "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]",
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', variables('containerAppName'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', variables('keyVaultName'), variables('storageAccountKeySecretName'))]",
      "properties": {
        "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2022-09-01').keys[0].value]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName')), '4633458b-17de-408a-b874-0445c86b69e6')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName')), '2018-11-30').principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('containerAppIdentityName'))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "condition": "[parameters('enableCommunicationServices')]",
      "type": "Microsoft.Communication/emailServices",
      "apiVersion": "2023-04-01",
      "name": "[variables('emailServiceName')]",
      "location": "global",
      "properties": {
        "dataLocation": "United States"
      }
    },
    {
      "condition": "[and(parameters('enableCommunicationServices'), equals(parameters('emailCustomDomain'), ''))]",
      "type": "Microsoft.Communication/emailServices/domains",
      "apiVersion": "2023-04-01",
      "name": "[format('{0}/{1}', variables('emailServiceName'), 'AzureManagedDomain')]",
      "location": "global",
      "properties": {
        "domainManagement": "AzureManaged"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Communication/emailServices', variables('emailServiceName'))]"
      ]
    },
    {
      "condition": "[and(parameters('enableCommunicationServices'), not(equals(parameters('emailCustomDomain'), '')))]",
      "type": "Microsoft.Communication/emailServices/domains",
      "apiVersion": "2023-04-01",
      "name": "[format('{0}/{1}', variables('emailServiceName'), parameters('emailCustomDomain'))]",
      "location": "global",
      "properties": {
        "domainManagement": "CustomerManaged"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Communication/emailServices', variables('emailServiceName'))]"
      ]
    },
    {
      "condition": "[parameters('enableCommunicationServices')]",
      "type": "Microsoft.Communication/communicationServices",
      "apiVersion": "2023-04-01",
      "name": "[variables('communicationServiceName')]",
      "location": "global",
      "properties": {
        "dataLocation": "United States",
        "linkedDomains": [
          "[if(equals(parameters('emailCustomDomain'), ''), resourceId('Microsoft.Communication/emailServices/domains', variables('emailServiceName'), 'AzureManagedDomain'), resourceId('Microsoft.Communication/emailServices/domains', variables('emailServiceName'), parameters('emailCustomDomain')))]"
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Communication/emailServices/domains', variables('emailServiceName'), parameters('emailCustomDomain'))]",
        "[resourceId('Microsoft.Communication/emailServices/domains', variables('emailServiceName'), 'AzureManagedDomain')]"
      ]
    },
    {
      "condition": "[not(equals(parameters('dnsZoneName'), ''))]",
      "type": "Microsoft.Network/dnsZones",
      "apiVersion": "2023-07-01-preview",
      "name": "[parameters('dnsZoneName')]",
      "location": "global"
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', variables('keyVaultName'), parameters('emailFromAddressSecretName'))]",
      "properties": {
        "value": "[variables('computedEmailFromAddress')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "condition": "[parameters('enableCommunicationServices')]",
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', variables('keyVaultName'), parameters('smtpSecretName'))]",
      "properties": {
        "value": "[variables('smtpPlaceholderValue')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "condition": "[not(equals(parameters('dnsZoneName'), ''))]",
      "type": "Microsoft.Network/dnsZones/CNAME",
      "apiVersion": "2023-07-01-preview",
      "name": "[format('{0}/{1}', parameters('dnsZoneName'), parameters('dnsRecordName'))]",
      "properties": {
        "TTL": 300,
        "CNAMERecord": {
          "cname": "[reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2023-05-01', 'full').properties.configuration.ingress.fqdn]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', variables('containerAppName'))]",
        "[resourceId('Microsoft.Network/dnsZones', parameters('dnsZoneName'))]"
      ]
    },
    {
      "condition": "[not(equals(parameters('dnsZoneName'), ''))]",
      "type": "Microsoft.Network/dnsZones/CNAME",
      "apiVersion": "2023-07-01-preview",
      "name": "[format('{0}/{1}', parameters('dnsZoneName'), format('*.{0}', parameters('dnsRecordName')))]",
      "properties": {
        "TTL": 300,
        "CNAMERecord": {
          "cname": "[reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2023-05-01', 'full').properties.configuration.ingress.fqdn]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', variables('containerAppName'))]",
        "[resourceId('Microsoft.Network/dnsZones', parameters('dnsZoneName'))]"
      ]
    },
    {
      "condition": "[not(equals(parameters('dnsZoneName'), ''))]",
      "type": "Microsoft.Network/dnsZones/TXT",
      "apiVersion": "2023-07-01-preview",
      "name": "[format('{0}/{1}', parameters('dnsZoneName'), format('asuid.{0}', parameters('dnsRecordName')))]",
      "properties": {
        "TTL": 300,
        "TXTRecords": [
          {
            "value": [
              "[reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2023-05-01', 'full').properties.customDomainVerificationId]"
            ]
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', variables('containerAppName'))]",
        "[resourceId('Microsoft.Network/dnsZones', parameters('dnsZoneName'))]"
      ]
    },
    {
      "condition": "[variables('managedCertificateEnabled')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-enable-sni', parameters('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "containerAppName": {
            "value": "[variables('containerAppName')]"
          },
          "hostname": {
            "value": "[parameters('pdsHostname')]"
          },
          "certificateId": {
            "value": "[variables('managedCertificateResourceId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16885970059261286595"
            }
          },
          "parameters": {
            "containerAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App to update with the managed certificate binding."
              }
            },
            "hostname": {
              "type": "string",
              "metadata": {
                "description": "Hostname to bind to the Container App."
              }
            },
            "certificateId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the managed certificate to associate with the hostname binding."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps/customDomains",
              "apiVersion": "2024-03-01",
              "name": "[format('{0}/{1}', parameters('containerAppName'), parameters('hostname'))]",
              "properties": {
                "bindingType": "SniEnabled",
                "certificateId": "[parameters('certificateId')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps/customDomains', variables('containerAppName'), parameters('pdsHostname'))]",
        "[resourceId('Microsoft.Network/dnsZones/TXT', parameters('dnsZoneName'), format('asuid.{0}', parameters('dnsRecordName')))]",
        "[resourceId('Microsoft.App/managedEnvironments/managedCertificates', variables('managedEnvName'), variables('managedCertificateName'))]"
      ]
    }
  ],
  "outputs": {
    "containerAppName": {
      "type": "string",
      "value": "[variables('containerAppName')]"
    },
    "containerAppFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2023-05-01', 'full').properties.configuration.ingress.fqdn]"
    },
    "storageAccountId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
    },
    "snapshotContainerResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', split(format('{0}/default/{1}', variables('storageAccountName'), parameters('snapshotContainerName')), '/')[0], split(format('{0}/default/{1}', variables('storageAccountName'), parameters('snapshotContainerName')), '/')[1], split(format('{0}/default/{1}', variables('storageAccountName'), parameters('snapshotContainerName')), '/')[2])]"
    },
    "snapshotContainerName": {
      "type": "string",
      "value": "[parameters('snapshotContainerName')]"
    },
    "keyVaultUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri]"
    },
    "communicationServiceEndpoint": {
      "type": "string",
      "value": "[if(parameters('enableCommunicationServices'), reference(resourceId('Microsoft.Communication/communicationServices', variables('communicationServiceName')), '2023-04-01').hostName, '')]"
    },
    "emailServiceName": {
      "type": "string",
      "value": "[if(parameters('enableCommunicationServices'), variables('emailServiceName'), '')]"
    },
    "managedCertificateResourceId": {
      "type": "string",
      "value": "[if(variables('useManagedCertificate'), resourceId('Microsoft.App/managedEnvironments/managedCertificates', variables('managedEnvName'), variables('managedCertificateName')), variables('ingressCertificateResourceId'))]"
    },
    "containerAppCustomDomainVerificationId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2023-05-01', 'full').properties.customDomainVerificationId]"
    },
    "smtpServer": {
      "type": "string",
      "value": "smtp.azurecomm.net"
    },
    "smtpPort": {
      "type": "int",
      "value": 587
    },
    "communicationServiceResourceId": {
      "type": "string",
      "value": "[if(parameters('enableCommunicationServices'), resourceId('Microsoft.Communication/communicationServices', variables('communicationServiceName')), '')]"
    },
    "emailDomainResourceId": {
      "type": "string",
      "value": "[if(parameters('enableCommunicationServices'), if(equals(parameters('emailCustomDomain'), ''), resourceId('Microsoft.Communication/emailServices/domains', variables('emailServiceName'), 'AzureManagedDomain'), resourceId('Microsoft.Communication/emailServices/domains', variables('emailServiceName'), parameters('emailCustomDomain'))), '')]"
    },
    "emailFromAddress": {
      "type": "string",
      "value": "[variables('computedEmailFromAddress')]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[variables('keyVaultName')]"
    }
  }
}